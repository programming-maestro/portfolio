<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Analytics â€” Chetan Maikhuri</title>
    <meta name="description" content="Website analytics dashboard" />

    <link rel="stylesheet" href="/assets/css/styles.css" />
    <link rel="stylesheet" href="/assets/css/analytics.css" />
    <script src="/assets/js/template.js" defer></script>
</head>

<body>
    <!-- Header injected by template.js -->
    <header id="site-header"></header>

    <main>
        <div class="page-shell">

            <!-- Hero -->
            <section class="page-hero">
                <div class="page-hero-text">
                    <div class="page-kicker">
                        <span class="page-kicker-dot"></span>
                        <span>Internal</span>
                        <span>Â· Analytics</span>
                    </div>

                    <h1 class="page-title">Website analytics</h1>
                    <p class="page-subtitle">
                        Read-only dashboard showing real visitor activity and trends.
                    </p>

                    <div class="hero-meta">
                        <span class="hero-pill">Auto updated</span>
                        <span class="hero-pill">Unique users</span>
                        <span class="hero-pill">Page visits</span>
                    </div>
                </div>

                <aside class="page-hero-aside">
                    <div class="hero-card">
                        <div class="hero-card-title">Access level</div>
                        <p>Private Â· Admin only Â· Session based</p>
                    </div>
                </aside>
            </section>

            <!-- AUTH GATE (unchanged logic) -->
            <section class="card" id="auth-gate">
                <h2>Admin access</h2>
                <p class="muted">Enter passphrase to view analytics</p>

                <input type="password" id="admin-pass" placeholder="Enter passphrase"
                    style="max-width: 260px; padding: 8px" />
                <button id="auth-btn" class="btn btn-primary">Unlock</button>

                <p id="auth-error" style="color:#e11d48;display:none;margin-top:8px">
                    Invalid passphrase
                </p>
            </section>

            <!-- ANALYTICS -->
            <div id="analytics-content" style="display:none">

                <!-- Summary -->
                <section class="section">
                    <header class="section-header">
                        <h2 class="section-title">Summary</h2>
                        <p class="section-subtitle">Overall traffic snapshot</p>
                    </header>

                    <div class="section-grid">
                        <div class="card analytics-stat">
                            <div class="stat-value" id="summary-unique">â€“</div>
                            <div class="stat-label">Total unique users</div>
                        </div>

                        <div class="card analytics-stat">
                            <div class="stat-value" id="summary-visits">â€“</div>
                            <div class="stat-label">Total visits</div>
                        </div>
                    </div>
                </section>

                <!-- Daily -->
                <section class="section">
                    <header class="section-header">
                        <h2 class="section-title">Daily unique users</h2>
                        <p class="section-subtitle">Last activity trend</p>
                    </header>

                    <div class="card">
                        <canvas id="dailyChart" height="120"></canvas>
                    </div>
                </section>

                <!-- Weekly -->
                <section class="section">
                    <header class="section-header">
                        <h2 class="section-title">Weekly unique users</h2>
                        <p class="section-subtitle">Week-over-week growth</p>
                    </header>

                    <div class="card">
                        <canvas id="weeklyChart" height="120"></canvas>
                    </div>
                </section>

                <!-- Page wise -->
                <section class="section">
                    <header class="section-header">
                        <h2 class="section-title">Page-wise visits</h2>
                        <p class="section-subtitle">Most viewed pages</p>
                    </header>

                    <div class="card">
                        <!-- <canvas id="pageChart"></canvas> -->
                        <canvas id="pageChart" height="200"></canvas>
                    </div>
                </section>

            </div>
        </div>
    </main>

    <!-- Footer injected by template.js -->
    <footer id="site-footer"></footer>
    <!-- Chart.js (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Page-specific JS -->
    <script>
        // const PASSPHRASE = "cmdm"; // ðŸ”’ CHANGE PASSPHRASE HERE

        const authGate = document.getElementById("auth-gate");
        const analyticsContent = document.getElementById("analytics-content");
        const authBtn = document.getElementById("auth-btn");
        const authInput = document.getElementById("admin-pass");
        const authError = document.getElementById("auth-error");
        const API_URL =
            "https://script.google.com/macros/s/AKfycbyJ0pSglHi9wVOAAWvVBq1vvxTf56z1X-afZBPxPrp4ZmlJoOpaYKE5r7gySFxhKJit/exec";

        if (sessionStorage.getItem("analytics_token")) {
            unlock();
        }
        // function unlock() {
        //     authGate.style.display = "none";
        //     analyticsContent.style.display = "block";
        //     loadAnalytics(); // fetch data only after auth
        // }
        function unlock() {
            const token = sessionStorage.getItem("analytics_token");
            if (!token) return;

            authGate.style.display = "none";
            analyticsContent.style.display = "block";
            loadAnalytics();
        }


        // Check existing session
        // if (sessionStorage.getItem("analytics_auth") === "true") {
        //     unlock();
        // }

        // authBtn.addEventListener("click", () => {

        //     if (authInput.value === PASSPHRASE) {
        //         sessionStorage.setItem("analytics_auth", "true");
        //         unlock();
        //     }

        //     else {
        //         authError.style.display = "block";
        //     }
        // }
        authBtn.addEventListener("click", async () => {
            authError.style.display = "none";

            const pass = authInput.value.trim();
            if (!pass) return;

            try {
                const res = await fetch(API_URL, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        action: "auth",
                        pass
                    })
                });

                const data = await res.json();

                if (data.success) {
                    // store token in session (tab-based)
                    sessionStorage.setItem("analytics_token", data.token);
                    unlock();
                } else {
                    authError.style.display = "block";
                }
            } catch (err) {
                authError.style.display = "block";
            }
        });
        /* =========================
            Theme color helper
        ========================= */
        function themeColors() {
            const css = getComputedStyle(document.documentElement);
            return {
                text: css.getPropertyValue("--color-text").trim(),
                muted: css.getPropertyValue("--color-text-muted").trim(),
                border: css.getPropertyValue("--color-border").trim(),
                accent: css.getPropertyValue("--color-accent").trim(),
                accentSoft: css.getPropertyValue("--color-accent-soft").trim()
            };
        }

        async function loadAnalytics() {
            const theme = themeColors();
            // const API_URL =
            //     "https://script.google.com/macros/s/AKfycbyJ0pSglHi9wVOAAWvVBq1vvxTf56z1X-afZBPxPrp4ZmlJoOpaYKE5r7gySFxhKJit/exec";

            // const res = await fetch(API_URL);
            const token = sessionStorage.getItem("analytics_token");
            if (!token) return;

            const res = await fetch(`${API_URL}?token=${token}`);

            const data = await res.json();

            // Summary
            document.getElementById("summary-unique").innerText =
                data.summary.total_unique_users;
            document.getElementById("summary-visits").innerText =
                data.summary.total_visits;

            const textColor = getComputedStyle(document.documentElement)
                .getPropertyValue("--color-text");

            /* Daily line chart */
            new Chart(document.getElementById("dailyChart"), {
                type: "line",
                data: {
                    labels: data.daily.map(d => d.date),
                    datasets: [{
                        data: data.daily.map(d => d.unique_users),
                        borderColor: theme.accent,
                        backgroundColor: theme.accentSoft,
                        fill: true,
                        tension: 0.35,
                        borderWidth: 2,
                        pointRadius: 3
                    }]
                },
                options: {
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            ticks: { color: theme.muted },
                            grid: { color: theme.border }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: theme.muted,
                                precision: 0,          // â¬… no decimals
                                callback: value => Math.round(value)
                            },
                            grid: {
                                color: theme.border
                            }
                        }
                    }
                }
            });


            /* Weekly bar chart */
            new Chart(document.getElementById("weeklyChart"), {
                type: "bar",
                data: {
                    labels: data.weekly.map(w => `${w.year}-W${w.week}`),
                    datasets: [{
                        data: data.weekly.map(w => w.unique_users),
                        backgroundColor: theme.accent
                    }]
                },
                options: {
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            ticks: { color: theme.muted },
                            grid: { color: theme.border }
                        },
                        // y: {
                        //     ticks: { color: theme.muted },
                        //     grid: { color: theme.border }
                        // }
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: theme.muted,
                                precision: 0,
                                callback: value => Math.round(value)
                            },
                            grid: {
                                color: theme.border
                            }
                        }
                    }
                }
            });


            /* Page-wise horizontal bar */
            const pageLabels = data.pages.map(p => p.page);
            const pageValues = data.pages.map(p => p.total_visits);

            const pageChartCanvas = document.getElementById("pageChart");
            pageChartCanvas.style.height = `${pageLabels.length * 32}px`;

            new Chart(pageChartCanvas, {
                type: "bar",
                data: {
                    labels: pageLabels,
                    datasets: [{
                        data: pageValues,
                        backgroundColor: theme.accent
                    }]
                },
                options: {
                    indexAxis: "y",
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: items => items[0].label
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                color: theme.muted,
                                autoSkip: false
                            },
                            grid: {
                                display: false
                            }
                        },
                        x: {
                            ticks: { color: theme.muted },
                            grid: { color: theme.border }
                        }
                    }
                }
            });

        }
    </script>

</body>

</html>